<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>V0.07.1 - Publicar Vaga - JobFishing</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; }
    input, textarea, select, button { width: 100%; margin-top: 10px; padding: 10px; font-size: 16px; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    .checkbox { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    #preview, #resultado { margin-top: 30px; padding: 20px; border: 1px solid #ccc; background: #f9f9f9; }
    .btn { background-color: #007BFF; color: white; border: none; padding: 10px; cursor: pointer; }
    .btn:hover { background-color: #0056b3; }
    #copiar { background-color: #28a745; }
    #copiar:hover { background-color: #1e7e34; }
  </style>
</head>
<body>
  <h1>Publique sua vaga de emprego</h1>
  <form id="job-form">
	<label>Categoria da vaga</label>
	<select id="categoria-select" name="category_id" required>
		<option value="">Carregando categorias...</option>
	</select>

    <label for="title">Título da vaga</label>
    <input type="text" id="title" name="title" required>

    <label for="description">Descrição</label>
    <textarea id="description" name="description" required></textarea>

    <label for="employer_phone">Telefone para contato (WhatsApp)</label>
    <input type="tel" id="employer_phone" name="employer_phone" required>

    <label for="days_valid">Duração do anúncio</label>
    <select name="days_valid" id="days_valid">
      <option value="3">3 dias</option>
      <option value="7">7 dias</option>
      <option value="14">14 dias</option>
    </select>

    <label for="estado-select">Estado</label>
    <select id="estado-select" required></select>
    <label for="regiao-select">Região</label>
    <select id="regiao-select" name="region" required></select>

    <label for="ingles">Nível de inglês necessário</label>
    <select name="ingles" id="ingles">
      <option value="Não é necessário">Não é necessário</option>
      <option value="Básico">Básico</option>
      <option value="Intermediário">Intermediário</option>
      <option value="Avançado">Avançado</option>
    </select>

    <div class="checkbox">
      <input type="checkbox" id="precisa_carro" name="precisa_carro">
      <label for="precisa_carro">Precisa ter carro?</label>
    </div>

    <div class="checkbox">
      <input type="checkbox" id="requer_itin" name="requer_itin">
      <label for="requer_itin">Requer ITIN Number?</label>
    </div>

    <button type="submit" class="btn" aria-label="Pré-visualizar e publicar anúncio">Pré-visualizar anúncio</button>
  </form>

  <div id="preview" role="region"></div>
  <div id="resultado" role="region"></div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  let allRegions = [];
  const API_URL = window.location.origin;

fetch("/categories")
  .then(res => res.json())
  .then(categories => {
    const select = document.getElementById("categoria-select");
    select.innerHTML = "";
    categories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat.id;
      opt.textContent = cat.name;
      select.appendChild(opt);
    });
  })
  .catch(err => {
    console.error("Erro ao carregar categorias:", err);
  });


  fetch(`${API_URL}/states`)
    .then(res => res.json())
    .then(states => {
      const estadoSelect = document.getElementById("estado-select");
      states.forEach(state => {
        const opt = document.createElement("option");
        opt.value = state.id;
        opt.textContent = state.name;
        estadoSelect.appendChild(opt);
      });
      return fetch(`${API_URL}/regions`);
    })
    .then(res => res.json())
    .then(regions => {
      allRegions = regions.filter(r => r.active);
      updateRegionOptions();
    })
    .catch(err => {
      console.error("Erro ao carregar estados ou regiões:", err);
    });

  document.getElementById("estado-select").addEventListener("change", updateRegionOptions);

  function updateRegionOptions() {
    const selectedStateId = parseInt(document.getElementById("estado-select").value);
    const regiaoSelect = document.getElementById("regiao-select");
    regiaoSelect.innerHTML = "";

    const filteredRegions = allRegions.filter(r => r.state_id === selectedStateId);
    filteredRegions.forEach(region => {
      const opt = document.createElement("option");
      opt.value = region.id;
      opt.textContent = region.name;
      regiaoSelect.appendChild(opt);
    });
  }

  document.getElementById("job-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = e.target;
    const regiaoNome = form.region.options[form.region.selectedIndex].text;

	const data = {
	  category_id: parseInt(form.category_id.value),
	  title: form.title.value.trim(),
	  description: form.description.value.trim(),
	  employer_phone: form.employer_phone.value.trim(),
	  days_valid: parseInt(form.days_valid.value),
	  state: form["estado-select"].value,  // <- adicionado
	  region: form.region.value,
	  ingles: form.ingles.value,
	  precisa_carro: form.precisa_carro.checked,
	  requer_itin: form.requer_itin.checked
	};

    if (!/^[0-9]+$/.test(data.employer_phone)) {
      alert("Telefone deve conter apenas números.");
      return;
    }

    document.getElementById("preview").innerHTML = `
      <h3>Pré-visualização:</h3>
      <p><strong>${data.title}</strong></p>
      <p>${data.description}</p>
      <p><strong>Contato:</strong> ${data.employer_phone}</p>
      <p><strong>Região:</strong> ${regiaoNome}</p>
      <p><strong>Inglês:</strong> ${data.ingles}</p>
      <p><strong>Precisa de carro:</strong> ${data.precisa_carro ? "Sim" : "Não"}</p>
      <p><strong>Requer ITIN:</strong> ${data.requer_itin ? "Sim" : "Não"}</p>
      <button id="confirmar" class="btn" aria-label="Confirmar publicação do anúncio">Confirmar e publicar</button>
    `;

document.getElementById("confirmar").onclick = async () => {
  const btn = document.getElementById("confirmar");
  btn.disabled = true;
  try {
    const res = await fetch(`${API_URL}/ads/create-ad`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    let result;
    try {
      result = await res.json();
    } catch (jsonError) {
      throw new Error("Erro inesperado: resposta inválida do servidor.");
    }

	if (!res.ok) {
	  let message = "Erro desconhecido";
	  if (result.detail) {
		if (Array.isArray(result.detail)) {
		  message = result.detail.map(e => e.msg).join("; ");
		} else if (typeof result.detail === "string") {
		  message = result.detail;
		} else {
		  message = JSON.stringify(result.detail);
		}
	  }
	  throw new Error(message);
	}


    document.getElementById("resultado").innerHTML = `
      <h3>✅ Anúncio publicado com sucesso!</h3>
      <p><a href="${result.short_link}" target="_blank">${result.short_link}</a></p>
      <button id="copiar" class="btn" aria-label="Copiar link do anúncio">Copiar link</button>
    `;
    document.getElementById("copiar").onclick = () => {
      navigator.clipboard.writeText(result.short_link);
      alert("Link copiado!");
    };

    form.reset();
    document.getElementById("preview").innerHTML = "";
  } catch (err) {
    alert(`Erro ao criar anúncio: ${err.message}`);
    console.error(err);
  } finally {
    btn.disabled = false;
  }
};

  });
});
</script>
</body>
</html>
